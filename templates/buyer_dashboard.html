<!DOCTYPE html>
<html>
<head>
    <title>Buyer Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h2>Buyer Dashboard - {{ username }}</h2>
    <p>Tokens: {{ tokens }}</p>
    <p>Balance: ₹{{ balance }}</p>
    <p id="marketPrice">Market Price: ₹{{ market_price|default('N/A', true) }}</p>
    <h3>Add Balance</h3>
    <form action="/add_balance" method="GET">
        <input type="submit" value="Add Balance">
    </form>
    <h3>Buy Tokens</h3>
    <form method="POST">
        Tokens to Buy: <input type="number" name="tokens" min="0.1" step="0.1" required><br>
        <input type="submit" value="Buy Tokens">
    </form>
    <a href="/history">View History</a> | <a href="/logout">Logout</a>
    <h3>Market Price History</h3>
    <canvas id="priceChart" width="400" height="200"></canvas>
    <script>
        const ctx = document.getElementById('priceChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Market Price (₹)', data: [], borderColor: 'blue', fill: false }] },
            options: { scales: { y: { beginAtZero: false } } }
        });

        function updateChartAndPrice() {
            fetch('/price_data')
                .then(response => response.json())
                .then(data => {
                    console.log('Price data received:', data); // Debug log
                    chart.data.labels = data.map(d => d.time);
                    chart.data.datasets[0].data = data.map(d => d.price);
                    chart.update();

                    // Update static market price text
                    const latestPrice = data.length > 0 ? data[data.length - 1].price : 'N/A';
                    document.getElementById('marketPrice').textContent = `Market Price: ₹${latestPrice}`;
                })
                .catch(error => console.error('Error fetching price data:', error));
        }

        setInterval(updateChartAndPrice, 5000);  // Update every 5 seconds
        updateChartAndPrice();  // Initial update
    </script>
</body>
</html>